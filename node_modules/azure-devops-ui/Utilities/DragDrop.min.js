import*as React from"react";import{ObservableValue}from"../Core/Observable";import{Observer}from"../Observer";import{Portal}from"../Portal";import{distance}from"./Position";import{getPointByEventType,Mouse,Touch,css}from"../Util";export var DragDropEffect;!function(e){e.none="none",e.move="move",e.copy="copy"}(DragDropEffect||(DragDropEffect={}));var DragDropManager=function(){function e(){var e=this;this.onEventCaptured=function(t){var r=t.type;if("mousemove"===r||"touchmove"==r){if(e.dragInProgress){if(a=e.getTargetFromEvent(t)){o=getPointByEventType(t);e.operation.x.value=o.x,e.operation.y.value=o.y,dispatchCustomDragEvent("dragover",a,t,e.dataTransfer)}}else if(e.potentialDragInProgress){var o=getPointByEventType(t);distance(e.initialCoordinates,o)>e.minimumPixelsForDrag&&(dispatchCustomDragEvent("dragstart",e.dragSourceElement,t,e.dataTransfer),"none"===e.dataTransfer.effectAllowed?(e.potentialDragInProgress=!1,e.endDrag()):e.dragInProgress=!0)}}else if("mouseup"===r||"touchend"===r){if(e.dragInProgress){var a=e.getTargetFromEvent(t);dispatchCustomDragEvent("dragend",e.dragSourceElement,t,e.dataTransfer),a&&"none"!==e.dataTransfer.dropEffect&&dispatchCustomDragEvent("drop",a,t,e.dataTransfer)}e.endDrag()}},this.onMouseLeave=function(t){e.dataTransfer.dropEffect="none"},this.onMouseOut=function(t){t.target&&(e.dataTransfer.dropEffect="none",dispatchCustomDragEvent("dragexit",t.target,t,e.dataTransfer))},this.onMouseOver=function(t){t.target&&(e.dataTransfer.dropEffect="none",dispatchCustomDragEvent("dragenter",t.target,t,e.dataTransfer))}}return e.prototype.beginDragOperation=function(e,t,r){if(void 0===r&&(r=4),this.operation=void 0,!this.dragInProgress)if("mousedown"===e.type)this.startDrag(e,r,t),this.initialCoordinates={x:e.clientX,y:e.clientY},Mouse.setCapture(this.onEventCaptured),document.body.addEventListener("mouseout",this.onMouseOut,!0),document.body.addEventListener("mouseover",this.onMouseOver,!0),document.body.addEventListener("mouseleave",this.onMouseLeave),this.operation={x:new ObservableValue(void 0),y:new ObservableValue(void 0)};else if("touchstart"===e.type){var o=e;if(1===o.touches.length){this.startDrag(e,r,t);var a=o.touches[0];this.initialCoordinates={x:a.clientX,y:a.clientY},Touch.setCapture(this.onEventCaptured),this.operation={x:new ObservableValue(void 0),y:new ObservableValue(void 0)}}}return this.operation},e.prototype.endDrag=function(){document.body.removeEventListener("mouseout",this.onMouseOut),document.body.removeEventListener("mouseover",this.onMouseOver),document.body.removeEventListener("mouseleave",this.onMouseLeave),this.dragInProgress=!1},e.prototype.getTargetFromEvent=function(e){if(e.touches||e.changedTouches){var t=getPointByEventType(e);return document.elementFromPoint(t.x,t.y)}return e.target},e.prototype.startDrag=function(e,t,r){this.potentialDragInProgress=!0,this.dragSourceElement=e.target,this.minimumPixelsForDrag=t,this.dataTransfer=r},e}(),dragDropManager=new DragDropManager;export function beginDragOperation(e,t,r){return dragDropManager.beginDragOperation(e,t,r)};export function dispatchCustomDragEvent(e,t,r,o){var a=new CustomEvent(e,{bubbles:!0,detail:{dataTransfer:o,nativeEvent:r}});return t.dispatchEvent(a),a};export var DragImage=function(e){var t=e.className,r=e.operation,o=e.xOffset,a=void 0===o?5:o,n=e.yOffset,s=void 0===n?5:n;return React.createElement(Portal,{className:"bolt-drag-image-portal"},React.createElement(Observer,{x:r.x,y:r.y},function(r){return void 0!==r.x&&void 0!==r.y?React.createElement("div",{className:css(t,"bolt-drag-image depth-16 absolute flex-row flex-center scroll-hidden justify-center"),style:{left:r.x+a+"px",top:r.y+s+"px"}},e.children):null}))};
import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./IdentityPicker.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{IdentityCard}from"../../IdentityCard";import{Observer}from"../../Observer";import{Persona}from"../../Persona";import*as Resources from"../../Resources.IdentityPicker";import{TagPicker}from"../../TagPicker";import{renderSuggestionItem}from"../IdentityPickerSuggestionsList/IdentityPickerSuggestionsListHelpers";import{makeCancelable}from"../../Core/Util/Promise";var IdentityPicker=function(e){function t(t){var n=e.call(this,t)||this;return n.openedIdentityCard=new ObservableValue(void 0),n.outerElement=React.createRef(),n.lastSearchVal="",n.suggestions=new ObservableArray([]),n.suggestionsLoading=new ObservableValue(!1),n.areTagsEqual=function(e,t){return e.entityId===t.entityId},n.renderSuggestionItem=function(e){return renderSuggestionItem(e,n.onOpenPersonaCard)},n.onOpenPersonaCard=function(e){n.openedIdentityCard.value=e},n.onClosePersonaCard=function(){n.openedIdentityCard.value=void 0},n.onEmptyInputFocus=function(){n.updateSuggestionsList(n.props.pickerProvider.onEmptyInputFocus())},n.onAddIdentity=function(e){!!n.props.pickerProvider.addIdentitiesToMRU&&n.props.pickerProvider.addIdentitiesToMRU([e]),n.props.onIdentityAdded(e)},n.convertItemToPill=function(e,t){return{className:"bolt-identity-picker-pill flex-row",content:e.displayName,onRenderFilledVisual:function(){return React.createElement(Persona,{className:"flex-row flex-center",identity:e,size:2})}}},n.onResolveSuggestions=function(e){n.lastSearchVal=e;var t=n.props.pickerProvider.onFilterIdentities(e,ObservableLike.getValue(n.props.selectedIdentities));null!==t&&(n.cachedResults[e]?n.suggestions.value=n.cachedResults[e].filter(function(e){return!ObservableLike.getValue(n.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})}):n.updateSuggestionsList(t,e))},n.cachedResults={},n.timerManagement=new TimerManagement,n}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this;return React.createElement("div",{ref:this.outerElement},React.createElement(Observer,{openedIdentityCard:this.openedIdentityCard},function(t){return React.createElement(React.Fragment,null,React.createElement(TagPicker,{suggestionsLoading:e.suggestionsLoading,areTagsEqual:e.areTagsEqual,convertItemToPill:e.convertItemToPill,noResultsFoundText:Resources.IdentityPickerNoResultsText,onEmptyInputFocus:e.onEmptyInputFocus,onSearchChanged:e.onResolveSuggestions,onTagAdded:e.onAddIdentity,onTagRemoved:e.props.onIdentityRemoved,onTagsRemoved:e.props.onIdentitiesRemoved,placeholderText:e.props.placeholderText||Resources.MultiIdentityPickerPlaceholderText,prefixIconProps:{className:"bolt-identity-picker-contact-icon justify-center fontSizeML flex-center",iconName:"Contact"},renderSuggestionItem:e.renderSuggestionItem,selectedTags:e.props.selectedIdentities,suggestions:e.suggestions,suggestionsLoadingText:Resources.Loading}),t.openedIdentityCard&&React.createElement(IdentityCard,{getEntityFromUniqueAttribute:e.props.pickerProvider.getEntityFromUniqueAttribute,key:t.openedIdentityCard.entityId,identity:t.openedIdentityCard,displayName:t.openedIdentityCard.displayName,target:e.outerElement.current,onDismissCallback:e.onClosePersonaCard,onRequestConnectionInformation:e.props.pickerProvider.onRequestConnectionInformation}))}))},t.prototype.componentDidMount=function(){this.onResolveSuggestions=this.timerManagement.debounce(this.onResolveSuggestions,250)},t.prototype.componentWillUnmount=function(){this.currentPromise&&this.currentPromise.cancel()},t.prototype.updateSuggestionsList=function(e,t){var n=this,r=e,i=e;if(Array.isArray(r))this.suggestions.value=r.filter(function(e){return!ObservableLike.getValue(n.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})});else if(i&&i.then){this.loadingTimer||(this.loadingTimer=this.timerManagement.setTimeout(function(){n.suggestionsLoading.value=!0},100));var o=this.currentPromise=makeCancelable(i);o.promise.then(function(e){o===n.currentPromise&&(n.suggestionsLoading.value=!1,t&&n.lastSearchVal!==t||(n.suggestions.value=e.filter(function(e){return!ObservableLike.getValue(n.props.selectedIdentities).some(function(t){return t.entityId===e.entityId})})),t&&""!==t&&n.suggestions.value&&n.suggestions.value.length>0&&(n.cachedResults[t]=e),n.loadingTimer&&(n.timerManagement.clearTimeout(n.loadingTimer),n.loadingTimer=void 0))})}},t}(React.Component);export{IdentityPicker};
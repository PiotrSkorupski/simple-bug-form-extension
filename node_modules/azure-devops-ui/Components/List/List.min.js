function getAttributeAsNumber(e,t){var o=e.getAttribute(t);return o?parseInt(o,10):-1}import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./List.css";import"./ListDropIndicator.css";import*as React from"react";import{ObservableArray,ObservableLike}from"../../Core/Observable";import{FocusWithin}from"../../FocusWithin";import{FocusZone,FocusZoneContext}from"../../FocusZone";import{Icon}from"../../Icon";import{Intersection,IntersectionContext}from"../../Intersection";import{Link}from"../../Link";import{Observer}from"../../Observer";import{Tooltip}from"../../TooltipEx";import{css,eventTargetContainsNode,getSafeId}from"../../Util";import{EventDispatch}from"../../Utilities/Dispatch";import{getTabIndex}from"../../Utilities/Focus";var List=function(e){function t(t){var o=e.call(this,t)||this;o.bodyElement=React.createRef(),o.listElement=React.createRef(),o.spacerElements={},o.scrollToIndex=-1,o.scrollToOptions=void 0,o.selectOnFocus=!0,o.focusIndex=-1,o.pivotIndex=-1,o.onClick=function(e){if(o.onDispatch(e),!e.defaultPrevented&&o.listElement.current&&!eventTargetContainsNode(e,["A"],o.listElement.current)){var t=cellFromEvent(e).rowIndex,r=ObservableLike.getValue(o.state.rows[t]);if(t>=0&&r){var i={data:r,index:t};o.processSelectionEvent(e,i),o.props.singleClickActivation&&o.rowActivated(e,i)}}},o.onDispatch=function(e){o.state.eventDispatch.dispatchEvent(e)},o.onDoubleClick=function(e){if(o.onDispatch(e),!e.defaultPrevented){var t=cellFromEvent(e).rowIndex,r=ObservableLike.getValue(o.state.rows[t]);t>=0&&r&&o.rowActivated(e,{data:r,index:t})}},o.onFocusBody=function(e){if(o.selectOnFocus){var t=o.props.selection;if(!t||t.selectOnFocus){var r=o.focusIndex;if(r>=0){var i=ObservableLike.getValue(o.state.rows[r]);i&&o.processSelectionEvent(e,{data:i,index:r})}}o.selectOnFocus=!1}},o.onFocusItem=function(e,t){var r=o.focusIndex;if(r!==e){r>=0?delete o.state.renderedRows[r]:void 0!==o.props.defaultTabbableRow&&delete o.state.renderedRows[o.props.defaultTabbableRow],delete o.state.renderedRows[e],o.focusIndex=e;var i=ObservableLike.getValue(o.state.rows[e]);i&&o.rowFocused(t,{data:i,index:e})}},o.onKeyDown=function(e){if(o.onDispatch(e),!e.defaultPrevented){var t=o.focusIndex,r=ObservableLike.getValue(o.state.rows[t]);if(r)if(13===e.which)t>=0&&!eventTargetContainsNode(e,["A"])&&o.rowActivated(e,{data:r,index:t});else if(32===e.which)o.processSelectionEvent(e,{data:r,index:t}),e.preventDefault();else if(38===e.which||40===e.which){var i=o.props.selection;i&&!i.selectOnFocus||(e.persist(),window.setTimeout(function(){o.focusIndex!=t&&o.processSelectionEvent(e,{data:r,index:o.focusIndex})},0))}}},o.onIntersect=function(){if(o.props.virtualize){var e=o.state.rowCount,t=o.state,r=t.firstRow,i=t.lastRow,n=t.rowHeight;if(o.listElement.current&&o.bodyElement.current){var s=o.bodyElement.current.children;if(0===n){if(s.length>0){for(var a=0,l=0,c=0;c<s.length;c++){var u=o.bodyElement.current.children[c].getBoundingClientRect().height;u>0&&(a+=u,l++)}l>0&&(n=Math.ceil(a/l))}if(0===n)return}for(var d,p,h=o.context.root.getBoundingClientRect(),m=r,v=i,c=0;c<s.length;c++){var f=s[c],w=getAttributeAsNumber(f,"data-row-index");if(w>=r&&w<=i){(x=f.getBoundingClientRect()).bottom<h.top-o.state.pageSize*o.state.rowHeight?m++:x.top>h.bottom+o.state.pageSize*o.state.rowHeight&&v--,w===r&&(d=f),w===i&&(p=f)}}if(m>v){var b=o.context.root.scrollTop-o.listElement.current.offsetTop;m=Math.max(0,Math.min(e,Math.floor(b/n))),v=Math.min(e,m+Math.ceil(h.height/n))}else{if(m===r&&d){(g=(x=d.getBoundingClientRect()).top-h.top)>0&&(m-=Math.ceil(g/n))}if(v===i&&p){var x=p.getBoundingClientRect(),g=h.bottom-x.bottom;g>0&&(v+=Math.ceil(g/n))}}m=Math.max(m,0),v=Math.min(v,e-1),m===r&&v===i&&n===o.state.rowHeight||o.setState({firstRow:m,lastRow:v,rowHeight:n})}}},o.onMouseDownBody=function(e){o.selectOnFocus=!1};var r=t.itemProvider.length,i=t.pageSize;if(o.state={columnCount:1,eventDispatch:t.eventDispatch||new EventDispatch,firstRow:0,itemProvider:t.itemProvider,lastRow:o.props.virtualize?Math.min(t.initialPageCount*i,r-1):r-1,overlays:new ObservableArray,pageSize:i,renderedRows:{},rowCount:r,rowHeight:t.rowHeight||0,rows:{},scrollTop:0},t.behaviors)for(var n=0,s=t.behaviors;n<s.length;n++){var a=s[n];a.initialize&&a.initialize(t,o,o.state.eventDispatch)}return o}return tslib_1.__extends(t,e),t.getDerivedStateFromProps=function(e,t){var o=e.itemProvider.length,r=t.firstRow,i=t.lastRow;o!==t.rowCount&&(r=Math.max(0,Math.min(t.firstRow,o)),i=e.virtualize?Math.max(r,Math.min(t.lastRow+(t.lastRow===t.rowCount-1?e.pageSize:0),o-1)):o-1);var n={firstRow:r,itemProvider:e.itemProvider,lastRow:i,pageSize:e.pageSize,rowCount:o};return e.itemProvider===t.itemProvider&&e.columnCount===t.columnCount||(n.columnCount=e.columnCount,n.renderedRows={},n.rows={}),n},t.prototype.render=function(){var e=this,t=this.props,o=t.className,r=t.focuszoneProps,i=t.id,n=t.maxWidth,s=t.minWidth,a=t.role,l=t.width,c=this.state,u=c.firstRow,d=c.lastRow,p=c.rowCount,h=this.focusIndex,m=[],v=0,f=u,w=Math.max(0,p-d-1),b=0,x=Number.MAX_SAFE_INTEGER,g=0;if(-1!==h&&(x=Math.max(0,h-3),g=Math.min(p,h+3),x<u?(v=x,f=u-(g=Math.min(g,u-1))-1):g>d&&(w=(x=Math.max(x,d+1))-d-1,b=Math.max(0,p-g-1))),m.push(this.renderSpacer("st1",v)),x<u)for(R=x;R<=g;R++)m.push(this.renderRow(R));m.push(this.renderSpacer("st2",f));for(R=u;R<=d;R++)m.push(this.renderRow(R));if(m.push(this.renderSpacer("sb2",w)),g>d)for(var R=x;R<=g;R++)m.push(this.renderRow(R));m.push(this.renderSpacer("sb1",b));var y=React.createElement("table",{"aria-colcount":this.props.columnCount,"aria-rowcount":this.state.itemProvider.length,className:css(o,"bolt-list relative"),id:getSafeId(i),onClick:this.onClick,onDoubleClick:this.onDoubleClick,onDragEnd:this.onDispatch,onDragEnter:this.onDispatch,onDragExit:this.onDispatch,onDragOver:this.onDispatch,onDragStart:this.onDispatch,onDrop:this.onDispatch,onKeyDown:this.onKeyDown,onKeyUp:this.onDispatch,onMouseDown:this.onDispatch,onTouchStart:this.onDispatch,ref:this.listElement,role:a||"listbox",style:{maxWidth:n,minWidth:s,width:l}},this.props.renderHeader&&this.props.renderHeader(),React.createElement("tbody",{className:"relative",onFocus:this.onFocusBody,onMouseDown:this.onMouseDownBody,ref:this.bodyElement},this.renderOverlay(this.listElement),m));return r&&(y=React.createElement(FocusZone,tslib_1.__assign({},r,{skipHiddenCheck:!0}),y)),React.createElement(Observer,{itemProvider:{filter:function(t,o){e.props.selection&&e.props.selection.onItemsChanged(t,o);var r={renderedRows:{},rows:{}};if(-1!==e.state.rowCount){var i=(t.addedItems?t.addedItems.length:0)-(t.removedItems?t.removedItems.length:0);i&&(r.rowCount=e.state.rowCount+i,r.firstRow=Math.max(0,Math.min(e.state.firstRow,r.rowCount-1)),r.lastRow=e.props.virtualize?Math.max(r.firstRow,Math.min(e.state.lastRow+(t.index>=e.state.firstRow&&t.index<=e.state.lastRow+1?Math.min(e.state.pageSize,i):0),r.rowCount-1)):r.rowCount-1)}return e.setState(r),!1},observableValue:this.props.itemProvider}},function(){return y})},t.prototype.componentDidMount=function(){this.context.register(this.onIntersect)},t.prototype.componentDidUpdate=function(){var e=this.scrollToIndex;if(-1!==e){var t=this.bodyElement.current,o=this.state,r=o.firstRow,i=o.lastRow;if(e>=r&&e<=i&&t)for(var n=0;n<t.children.length;n++){var s=t.children[n];if(cellFromElement(s).rowIndex===e){s.scrollIntoView(this.scrollToOptions);break}}this.scrollToIndex=-1,this.scrollToOptions=void 0}},t.prototype.componentWillUnmount=function(){this.context.unregister(this.onIntersect)},t.prototype.addOverlay=function(e,t,o,r){void 0===r&&(r=0);var i=this.state.overlays,n=i.value.findIndex(function(t){return t.id===e}),s={render:o,id:e,rowIndex:t,zIndex:r+1};n>=0?i.change(n,s):i.push(s)},t.prototype.removeOverlay=function(e){var t=this.state.overlays,o=t.value.findIndex(function(t){return t.id===e});o>=0&&t.splice(o,1)},t.prototype.getFocusIndex=function(){return this.focusIndex},t.prototype.scrollIntoView=function(e,t){var o=this.state,r=o.firstRow,i=o.lastRow;if(e>=0&&e<this.state.rowCount){var n=this.bodyElement.current;if(e>=r&&e<=i&&n)for(var s=0;s<n.children.length;s++){var a=n.children[s];if(cellFromElement(a).rowIndex===e){a.scrollIntoView(t);break}}else this.scrollToIndex=e,this.scrollToOptions=t,this.setState({firstRow:e,lastRow:e})}},t.prototype.processSelectionEvent=function(e,t){var o=this.props.selection;if(!o||o.selectable(t.index)){var r=!1,i=!0;if(o){var n=t.index;r=o.selected(n),this.pivotIndex>=0&&e.shiftKey&&o.multiSelect?o.select(Math.min(this.pivotIndex,n),Math.abs(this.pivotIndex-n)+1,e.ctrlKey||e.metaKey):(e.ctrlKey||e.metaKey||o.alwaysMerge)&&o.multiSelect?(o.toggle(n,!0),i=!1):o.select(n,1,!1),e.shiftKey||(this.pivotIndex=n)}r!==i&&this.rowSelected(e,t)}},t.prototype.renderLoadingRow=function(e,t){return React.createElement(ListItem,{className:"bolt-list-row-loading",details:t,index:e},React.createElement("div",{className:"shimmer shimmer-line",style:{width:80*Math.random()+20+"%"}},"Â "))},t.prototype.renderOverlay=function(e){var t=this,o=this.state,r=o.firstRow,i=o.lastRow,n=o.overlays;return React.createElement(Observer,{overlays:n},function(o){var n=t.bodyElement.current;return o.overlays.length>0&&n?React.createElement("div",{className:"bolt-list-overlay-container absolute"},o.overlays.map(function(t){if(t.rowIndex<r||t.rowIndex>i)return null;var o=e.current&&e.current.querySelector("[data-row-index='"+t.rowIndex+"']");return o?React.createElement("div",{className:"bolt-list-overlay flex-row absolute",id:getSafeId(t.id),key:t.id,style:{height:o.offsetHeight,top:o.getBoundingClientRect().top-n.getBoundingClientRect().top,zIndex:10*t.zIndex}},t.render({rowElement:o})):null})):null})},t.prototype.renderRow=function(e){var t=this,o=this.props.itemProvider,r=this.state,i=r.renderedRows,n=r.rows,s=i[e];if(!s){var a=n[e];if(a||(a=o.getItem?o.getItem(e):o.value[e]),!a)return null;n[e]=a;var l=this.props.selection,c=void 0;l&&(c={observableValue:l,filter:function(t){for(var o=0,r=t;o<r.length;o++){var i=r[o];if(e>=i.beginIndex&&e<=i.endIndex)return!0}return!1}}),s=React.createElement(Observer,{item:a,key:e,selection:c},function(o){var r=t.props,i=r.renderRow,n=r.defaultTabbableRow,s=r.renderLoadingRow,l=t.focusIndex,c=l>=0?l:n,u=ObservableLike.getValue(a),d={ariaBusy:!o.item,eventDispatch:t.state.eventDispatch,data:u,listProps:t.props,onFocusItem:t.onFocusItem,excludeTabStop:c!==e};return o.item?i(e,o.item,d):s?s(e,d):t.renderLoadingRow(e,d)}),this.state.renderedRows[e]=s}return s},t.prototype.renderSpacer=function(e,t){var o=this;return React.createElement("tr",{className:"bolt-list-row-spacer",key:e,ref:function(t){var r=o.spacerElements[e];t?r!==t&&(r&&o.context.unobserve(t),o.context.observe(t),o.spacerElements[e]=t):r&&(o.context.unobserve(r),delete o.spacerElements[e])}},React.createElement("td",{className:"bolt-list-cell-spacer",colSpan:this.props.columnCount,style:{height:t*this.state.rowHeight+"px"}}))},t.prototype.rowActivated=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"activate"),!e.defaultPrevented&&this.props.onActivate&&this.props.onActivate(e,t),e.preventDefault()},t.prototype.rowSelected=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"select"),!e.defaultPrevented&&this.props.onSelect&&this.props.onSelect(e,t)},t.prototype.rowFocused=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"focus"),this.props.onFocus&&this.props.onFocus(e,t)},t.contextType=IntersectionContext,t.defaultProps={columnCount:1,defaultTabbableRow:0,focuszoneProps:{direction:2},initialPageCount:3,pageSize:10,role:"listbox",singleClickActivation:!1,virtualize:!0},t}(React.Component);export{List};var ScrollableList=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.list=React.createRef(),t}return tslib_1.__extends(t,e),t.prototype.render=function(){return React.createElement(Intersection,{rootMargin:window.innerHeight/2},React.createElement("div",{className:"flex-grow scroll-auto"},React.createElement(List,tslib_1.__assign({},this.props,{ref:this.list}))))},t.prototype.addOverlay=function(e,t,o,r){if(void 0===r&&(r=0),this.list.current)return this.list.current.addOverlay(e,t,o,r)},t.prototype.removeOverlay=function(e){if(this.list.current)return this.list.current.removeOverlay(e)},t.prototype.getFocusIndex=function(){return this.list.current?this.list.current.getFocusIndex():-1},t.prototype.scrollIntoView=function(e,t){if(this.list.current)return this.list.current.scrollIntoView(e,t)},t}(React.Component);export{ScrollableList};var SimpleList=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.list=React.createRef(),t.renderListItem=function(e,t,o){return renderListItem(e,o,renderListCell(t))},t}return tslib_1.__extends(t,e),t.prototype.render=function(){var e={className:this.props.className,columnCount:1,eventDispatch:this.props.eventDispatch,focuszoneProps:this.props.focuszoneProps,id:this.props.id,initialPageCount:this.props.initialPageCount,itemProvider:this.props.itemProvider,onActivate:this.props.onActivate,onFocus:this.props.onFocus,onSelect:this.props.onSelect,renderRow:this.renderListItem,selection:this.props.selection,width:this.props.width,virtualize:this.props.virtualize};return this.props.scrollable?React.createElement(ScrollableList,tslib_1.__assign({},e,{ref:this.list})):React.createElement(List,tslib_1.__assign({},e,{ref:this.list}))},t.prototype.addOverlay=function(e,t,o,r){if(void 0===r&&(r=0),this.list.current)return this.list.current.addOverlay(e,t,o,r)},t.prototype.removeOverlay=function(e){if(this.list.current)return this.list.current.removeOverlay(e)},t.prototype.getFocusIndex=function(){return this.list.current?this.list.current.getFocusIndex():-1},t.prototype.scrollIntoView=function(e,t){if(this.list.current)return this.list.current.scrollIntoView(e,t)},t}(React.Component);export{SimpleList};export function renderListItem(e,t,o){return React.createElement(ListItem,{details:t,index:e},o)};var ListItem=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onFocus=function(e){t.props.details.onFocusItem(t.props.index,e)},t}return tslib_1.__extends(t,e),t.prototype.render=function(){var e,t=this,o=this.props,r=o.children,i=o.details,n=o.index,s=o.linkProps,a=i.ariaBusy,l=i.ariaLabel,c=i.ariaPosInSet,u=i.ariaSetSize,d=i.excludeFocusZone,p=i.listProps,h=p.selection,m=p.singleClickActivation,v=s?"a":"tr",f=s?"div":"td";return s&&(e={disabled:s.disabled,href:s.href,id:s.id,rel:s.rel,role:s.role,target:s.target}),React.createElement(FocusWithin,{onFocus:this.onFocus},function(o){return React.createElement(FocusZoneContext.Consumer,null,function(p){return React.createElement(FocusZone,{direction:1},React.createElement(v,tslib_1.__assign({},e,{"aria-busy":a,"aria-label":l,"aria-posinset":void 0===c?n+1:null===c?void 0:c,"aria-selected":h&&h.selected(n),"aria-setsize":void 0===u?t.props.details.listProps.itemProvider.length:null===u?void 0:u,className:css(t.props.className,"bolt-list-row",0===n&&"first-row",s&&"bolt-link",h&&h.selected(n)&&"selected",o.hasFocus&&"focused",m&&"single-click-activation"),"data-focuszone":d?void 0:p.focuszoneId,"data-row-index":n,tabIndex:getTabIndex(i),onBlur:o.onBlur,onFocus:o.onFocus,role:"listitem"}),React.createElement(f,{className:"bolt-list-cell","data-column-index":0},React.createElement("div",{className:"bolt-list-cell-content flex-row"},r))))})})},t}(React.Component);export{ListItem};export function renderListCell(e){var t=void 0,o=React.createElement(Tooltip,{overflowOnly:!0},React.createElement("span",{className:"text-ellipsis"},"string"==typeof e||"number"==typeof e?e:e.text)),r=o,i=css("bolt-list-cell-child flex-row flex-center");return"string"!=typeof e&&"number"!=typeof e&&(t=e.textClassName,e.iconProps&&(r=React.createElement(React.Fragment,null,Icon(tslib_1.__assign({},e.iconProps,{className:css("bolt-list-cell-child",e.iconProps.className)})),o)),e.href)?React.createElement(Link,{className:css(t,i,"scroll-hidden"),href:e.href,excludeTabStop:!0,subtle:!0},r):React.createElement("span",{className:css(t,i,"bolt-list-cell-text")},r)};export function cellFromElement(e){for(var t,o=-1,r=-1,i=null;e;){if(-1!==(t=getAttributeAsNumber(e,"data-column-index"))&&(o=t,i=e),-1!==(t=getAttributeAsNumber(e,"data-row-index"))){r=t;break}if(e.classList.contains("bolt-list")){e=null;break}e=e.parentElement}return{cellElement:i,cellIndex:o,rowElement:e,rowIndex:r}};export function cellFromEvent(e){return cellFromElement(e.target)};
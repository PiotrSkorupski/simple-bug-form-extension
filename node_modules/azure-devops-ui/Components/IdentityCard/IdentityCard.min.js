import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./IdentityCard.css";import*as React from"react";import{IdentityCardContent}from"./IdentityCardContent";import*as Utils from"./IdentityCardIdentityUtils";var IdentityCard=function(t){function i(i){var e=t.call(this,i)||this;e.onDismissCallback=function(){e.props.onDismissCallback&&e.props.onDismissCallback()},e.headerOnClickHandler=function(){e.state.dataState.previousDataState?e.setState({dataState:e.state.dataState.previousDataState,working:!1}):e.props.initialHeader&&e.props.initialHeader.onClickFunction&&e.props.initialHeader.onClickFunction()},e.onShowContactCard=function(){var t=tslib_1.__assign({},e.state.dataState,{previousDataState:e.state.dataState,cardType:1,header:e.state.dataState.identity});e.setState({dataState:t})},e.onShowOrganizationCard=function(){if(!e.state.working&&!e.dismissed){var t=e.state.dataState;if(t.isGroup){var i=e.state.dataState,s=tslib_1.__assign({},i,{cardType:2,header:i.identity,previousDataState:i});e.setState({dataState:s}),(!i.successors||i.successors.length<=1)&&(e.setState({working:!0}),e.resolveIdentity(s,e.props.onRequestConnectionInformation(i.identity)))}else if(t.managerList&&t.managerList.length<=1){var a=e.state.dataState,s=tslib_1.__assign({},a,{cardType:2,header:a.identity,previousDataState:a});e.setState({dataState:s,working:!0}),e.resolveIdentity(s,e.props.onRequestConnectionInformation(a.identity,!0))}else{var n=e.state.dataState,s=tslib_1.__assign({},n,{cardType:2,header:n.identity,previousDataState:n});e.setState({dataState:s,working:!1})}}},e.onClickEntity=function(t){if(!e.state.working){var i=e.state.dataState,s={identity:t,cardType:0,header:i.identity,isGroup:Utils.isGroup(i.identity),directReportList:[],managerList:[],previousDataState:i,displayName:t.displayName,imageUrl:t.image,email:t.mail};e.setState({dataState:s,working:!0}),e.getIdentityByUniqueAttribute(t)}},e.updateConnections=function(t,i){e.dismissed||e.state.dataState&&t.identity===e.state.dataState.identity&&e.setState({dataState:tslib_1.__assign({},e.state.dataState,{managerList:i.managers&&i.managers.reverse(),directReportList:i.directReports,successors:i.successors}),working:!1})},e.updateEntity=function(t){var i=Utils.isCompleteIdentity(t,!0),s=Utils.isGroup(t)&&(!e.state.dataState.successors||e.state.dataState.successors.length<=0)||Utils.isAadUser(t)||Utils.isAdUser(t),a=e.props.imageUrl?e.props.imageUrl:t.image,n=tslib_1.__assign({},e.state.dataState,{identity:t,displayName:t.displayName,imageUrl:a,isGroup:Utils.isGroup(t)});i?s?(e.setState({dataState:n,working:!1}),e.resolveIdentity(n,e.props.onRequestConnectionInformation(n.identity))):e.setState({dataState:n,working:!1}):e.setState({working:!0})};var s={identity:i.identity,managerList:void 0,directReportList:void 0,previousDataState:void 0,cardType:0,header:i.initialHeader?i.initialHeader.identity:void 0,displayName:i.displayName,imageUrl:i.imageUrl,email:e.getEmail(),isGroup:Utils.isGroup(i.identity)},a=!0;return i.identity||i.uniqueAttribute||!i.displayName||(s.identity={entityId:"",entityType:"user",originDirectory:"vsd",originId:"",displayName:i.displayName,image:i.imageUrl,signInAddress:s.email},a=!1),e.state={dataState:s,working:a},e}return tslib_1.__extends(i,t),i.prototype.componentDidMount=function(){this.state.working&&this.setupInitialData(this.props.uniqueAttribute)},i.prototype.componentWillUnmount=function(){this.dismissed=!0},i.prototype.render=function(){return this.props.uniqueAttribute||this.props.identity||this.props.displayName?React.createElement(IdentityCardContent,tslib_1.__assign({},this.props,{dataProps:this.state.dataState,onClickEntity:this.onClickEntity,onDismissCallback:this.onDismissCallback,onShowContactCard:this.onShowContactCard,onShowOrganizationCard:this.onShowOrganizationCard,working:this.state.working,onHeaderClick:this.headerOnClickHandler})):React.createElement("div",null)},i.prototype.setupInitialData=function(t){var i=this.state.dataState;!i.identity&&t?this.getIdentityByUniqueAttribute(t):i.identity&&!Utils.isCompleteIdentity(i.identity)?this.getIdentityByUniqueAttribute(i.identity):Utils.isGroup(i.identity)&&i.successors&&i.successors.length>0?this.resolveIdentity(i,{successors:i.successors}):this.resolveIdentity(i,this.props.onRequestConnectionInformation(i.identity))},i.prototype.resolveIdentity=function(t,i){var e=this,s=i,a=i;a&&a.then?a.then(function(i){e.updateConnections(t,i)}):s&&this.updateConnections(t,s)},i.prototype.resolveIEntity=function(t){var i=this,e=t,s=t;s&&s.then?s.then(function(t){i.updateEntity(t)}):e&&this.updateEntity(e)},i.prototype.getIdentityByUniqueAttribute=function(t){var i;i="string"==typeof t?t:Utils.isGroup(t)||Utils.isAadUser(t)||Utils.isAdUser(t)?t.entityId:t.signInAddress?t.signInAddress:"",this.resolveIEntity(this.props.getEntityFromUniqueAttribute(i))},i.prototype.getEmail=function(){if(this.props.identity){if((Utils.isAadUser(this.props.identity)||Utils.isAdUser(this.props.identity))&&this.props.identity.mail)return this.props.identity.mail;if(this.props.identity&&this.props.identity.signInAddress)return this.props.identity.signInAddress;if(this.props.identity&&this.props.identity.mail)return this.props.identity.mail;if(this.props.uniqueAttribute){var t=this.props.uniqueAttribute.split("@");if(2===t.length&&t[0].length>=1&&t[1].length>=3){if(t[1].split(".").length>1)return this.props.uniqueAttribute}}}return""},i}(React.Component);export{IdentityCard};
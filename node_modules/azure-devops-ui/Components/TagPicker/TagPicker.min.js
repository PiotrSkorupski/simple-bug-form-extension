import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./TagPicker.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{Callout}from"../../Callout";import{FocusWithin}from"../../FocusWithin";import{Icon}from"../../Icon";import{Measure}from"../../Measure";import{Observer}from"../../Observer";import{Pill}from"../../Pill";import{SuggestionsList}from"../../SuggestionsList";import{css,getSafeId}from"../../Util";var TagPicker=function(e){function t(t){var s=e.call(this,t)||this;return s.inputElement=React.createRef(),s.outerElement=React.createRef(),s.textValue=new ObservableValue(""),s.suggestionsVisible=new ObservableValue(!1),s.selectedIndex=new ObservableValue(-1),s.selectableTags=new ObservableArray([]),s.onBlur=function(){s.suggestionsVisible.value||(s.textValue.value="",s.selectableTags.value=[])},s.onOuterKeyDown=function(e){switch(e.which){case 46:case 8:!e.isDefaultPrevented()&&s.selectableTags.value.length>0&&(s.props.onTagsRemoved&&s.props.onTagsRemoved(s.selectableTags.value),s.selectableTags.value=[],s.focusInput(),e.preventDefault())}},s.onKeyDown=function(e){var t=e.which,n=s.suggestionsVisible.value,a=ObservableLike.getValue(s.props.suggestions);switch(t){case 27:s.onSuggestionsDismiss(),e.preventDefault();break;case 9:case 13:if(!e.shiftKey)if(n)s.completeSuggestion(),e.preventDefault();else if(s.props.createDefaultItem){var l=s.props.createDefaultItem(s.textValue.value,a);l&&s.addItem(l),e.preventDefault()}break;case 38:n&&(s.selectedIndex.value=Math.max(0,s.selectedIndex.value-1),e.preventDefault());break;case 40:n?(s.selectedIndex.value=Math.min(a.length-1,s.selectedIndex.value+1),e.preventDefault()):(""!==s.textValue.value||a.length>0)&&(s.suggestionsVisible.value=!0,e.preventDefault())}},s.onInputClick=function(e){s.props.onEmptyInputFocus&&s.props.onEmptyInputFocus(),s.suggestionsVisible.value=!0,e&&e.preventDefault()},s.onInputChange=function(e){s.textValue.value=e.target.value,s.props.onSearchChanged(e.target.value),s.selectedIndex.value=""===e.target.value?-1:0,s.suggestionsVisible.value=!0,e.preventDefault()},s.onTagClicked=function(e,t){if(!e||!e.isDefaultPrevented()){var n=s.indexOfTag(t,s.selectableTags.value);if(!s.props.onTagsRemoved)return;n<0?s.selectableTags.push(t):s.selectableTags.splice(n,1),e&&e.preventDefault()}},s.onTagRemoved=function(e){var t=s.indexOfTag(e,s.selectableTags.value);t>=0&&s.selectableTags.splice(t,1),s.props.onTagRemoved(e)},s.onTagPickerSizeChanged=function(e,t){s.setState({width:e})},s.completeSuggestion=function(){var e=ObservableLike.getValue(s.props.suggestions)[s.selectedIndex.value];!!e&&s.addItem(e)},s.onSuggestionClick=function(e){s.addItem(e.item)},s.addItem=function(e){s.suggestionsVisible.value=!1,s.props.onTagAdded(e),s.textValue.value="",s.selectedIndex.value=-1,s.focusInput()},s.enterEditMode=function(){s.focusInput(),s.onInputClick()},s.focusInput=function(){s.inputElement.current&&(s.inputElement.current.focus(),s.inputElement.current.select())},s.onSuggestionsDismiss=function(){s.suggestionsVisible.value=!1,s.focusInput()},s.indexOfTag=function(e,t){return t.findIndex(function(t){return s.props.areTagsEqual(t,e)})},s.state={width:296},s}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this,t=this.props,s=t.ariaLabel,n=t.convertItemToPill,a=t.createDefaultItem,l=t.noResultsFoundText,o=t.onTagsRemoved,i=t.placeholderText,r=t.prefixIconProps,c=t.renderSuggestionItem,u=t.selectedTags,g=t.suggestions,p=t.suggestionsLoading,d=t.suggestionsLoadingText;return React.createElement(React.Fragment,null,React.createElement(FocusWithin,{onBlur:this.onBlur},function(t){return React.createElement(Observer,{suggestionsVisible:e.suggestionsVisible,selectedIndex:e.selectedIndex,selectableTags:e.selectableTags,selectedTags:u,suggestions:g,textValue:e.textValue},function(l){if(a){var c=a(e.textValue.value,l.suggestions.concat(l.selectedTags));c&&l.suggestions.unshift(c)}return React.createElement(Measure,{onMeasure:e.onTagPickerSizeChanged},React.createElement("div",{className:css("bolt-tag-picker",(t.hasFocus||l.suggestionsVisible)&&"edit"),ref:e.outerElement,onBlur:t.onBlur,onFocus:t.onFocus},React.createElement("div",{className:"bolt-tag-picker-group flex-center flex-row flex-wrap",onKeyDown:o&&e.onOuterKeyDown},0===l.selectedTags.length&&r?React.createElement(Icon,tslib_1.__assign({},r,{className:css(r.className,"bolt-tag-picker-prefix-icon")})):null,l.selectedTags.map(function(t,s){var a=n(t,s),i=e.indexOfTag(t,l.selectableTags);return React.createElement("div",{key:getSafeId("bolt-tag-picker-pill"+s),className:"scroll-hidden"},React.createElement(Pill,tslib_1.__assign({},a,{className:css("bolt-tag-picker-pill",o&&"bolt-people-picker-pill-selectable",i>=0&&"active"),contentClassName:"text-ellipsis",onClick:function(s){e.onTagClicked(s,t)},onRemoveClick:function(s){e.onTagRemoved(t),s.preventDefault()}}),a.content))}),React.createElement("div",{className:"bolt-tag-picker-add-icon-div flex-row"},!t.hasFocus&&l.selectedTags.length>0&&!l.suggestionsVisible&&React.createElement(Icon,{className:"bolt-tag-picker-add-icon cursor-pointer",iconName:"Add",onClick:e.focusInput}),React.createElement("input",{"aria-label":s,"aria-expanded":l.suggestionsVisible,"aria-haspopup":"true",className:"bolt-tag-picker-input flex-row flex-grow scroll-hidden",onChange:e.onInputChange,onKeyDown:e.onKeyDown,onClick:e.onInputClick,placeholder:0===l.selectedTags.length||t.hasFocus?i:void 0,ref:e.inputElement,role:"comboBox",type:"text",value:l.textValue})))))})}),React.createElement(Observer,{suggestionsVisible:this.suggestionsVisible,suggestionsLoading:p,selectedIndex:this.selectedIndex,suggestions:g,textValue:this.textValue},function(t){return t.suggestionsVisible?React.createElement(Callout,{anchorElement:e.outerElement.current||void 0,anchorOrigin:{horizontal:"start",vertical:"end"},calloutOrigin:{horizontal:"start",vertical:"start"},contentClassName:"bolt-tag-picker-callout-content scroll-hidden",contentShadow:!0,onDismiss:e.onSuggestionsDismiss,lightDismiss:!0},React.createElement(SuggestionsList,{isLoading:t.suggestionsLoading,loadingText:d,noResultsFoundText:l,onSuggestionClicked:e.onSuggestionClick,renderSuggestion:c,selectedIndex:t.selectedIndex,suggestions:t.suggestions,width:e.state.width})):React.createElement("div",null)}))},t}(React.Component);export{TagPicker};
import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Dropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import*as Utils_Accessibility from"../../Core/Util/Accessibility";import{format}from"../../Core/Util/String";import{Button,ExpandableButton}from"../../Button";import{Callout}from"../../Callout";import{FocusZone}from"../../FocusZone";import{FilteredListSelection}from"../../List";import{getListBoxItemsValue,getUnselectableRanges,ListBox,wrapListBoxItems}from"../../ListBox";import{ItemsObserver,Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{TextField}from"../../TextField";import{css,getSafeId}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{getItemsValue}from"../../Utilities/Provider";var dropdownId=1,ITEMS_FOR_FILTER=10,Dropdown=function(e){function t(t){var n=e.call(this,t)||this;n.expandableButton=React.createRef(),n.filterText=new ObservableValue(""),n.filteredItems=new ObservableArray,n.filteredIndexMap=[],n.collapse=function(){n.expandableButton.current&&n.expandableButton.current.collapse()},n.expand=function(){n.expandableButton.current&&n.expandableButton.current.expand()},n.onExpand=function(){n.props.onExpand&&n.props.onExpand(),n.updateFilteredItems()},n.onDismiss=function(){n.expandableButton.current&&n.expandableButton.current.collapse(),n.filterText.value="",n.props.onFilterTextChanged&&n.props.onFilterTextChanged(null,""),n.updateFilteredItems()},n.renderDropdown=function(e,t,r,o,l,i,s){var a=n.props,c=a.actions,d=a.calloutContentClassName,p=a.className,u=a.containerClassName,m=a.filteredItems,f=a.filteredNoResultsText,x=a.getUnselectableRanges,b=a.items,I=a.loading,v=a.onSelect,g=a.renderItem,h=a.searching,w=a.showFilterBox,R=a.width;return React.createElement(Callout,{anchorElement:r,anchorOffset:o,anchorOrigin:l,anchorPoint:i,blurDismiss:!0,calloutOrigin:s,contentClassName:css(d,"bolt-dropdown flex-column custom-scrollbar v-scroll-auto h-scroll-hidden"),contentShadow:!0,escDismiss:!0,id:t,onDismiss:n.onDismiss},React.createElement(FocusZone,{circularNavigation:!0,defaultActiveElement:w?"#"+getSafeId(n.textFieldId):".bolt-dropdown-container",direction:2,focusOnMount:!0},React.createElement("div",{className:"bolt-dropdown-container",tabIndex:-1},React.createElement(Observer,{items:b},function(){return(void 0===w?b.length>ITEMS_FOR_FILTER:w)?React.createElement("div",{className:"bolt-dropdown-filter-container"},React.createElement(TextField,{className:"bolt-dropdown-filter",excludeTabStop:!0,inputId:n.textFieldId,onChange:n.onFilterTextChanged,prefixIconProps:{iconName:"Search"},value:n.filterText})):null}),React.createElement(Observer,{listBoxItems:{observableValue:b,filter:n.updateFilteredItems},userFilteredItems:{observableValue:m,filter:n.updateFilteredItems},filteredItems:n.filteredItems},function(){var e=null,t="";return 0===b.length?t=n.props.noItemsText:0===n.filteredItems.length&&""!==n.filterText.value&&(t=format(f||Resources.NoFilterResults,n.filterText.value)),t&&(e=React.createElement("div",{className:"bolt-dropdown-no-items"},t)),React.createElement(React.Fragment,null,e,React.createElement(ListBox,{className:p,containerClassName:css("bolt-dropdown-list-box-container",u),excludeTabStop:!0,focuszoneProps:null,getUnselectableRanges:x,items:n.filteredItems.value,loading:I,onActivate:n.onActivate,onSelect:v,renderItem:g,searching:h,selection:n.filteredSelection,width:R}))}),React.createElement(Observer,{actions:c},function(e){return e.actions&&e.actions.length?React.createElement("div",{className:"bolt-actions-container flex-column"},ObservableLike.getValue(e.actions).map(function(e,t){return React.createElement(Button,tslib_1.__assign({key:e.id||t,subtle:!0,excludeTabStop:!0},e))})):null}))))},n.onActivate=function(e,t){e.defaultPrevented||"keydown"!==e.type||(n.filteredSelection.toggle(n.filteredItems.value.indexOf(t),n.filteredSelection.alwaysMerge),n.props.onSelect&&n.props.onSelect(e,t))},n.onFilterTextChanged=function(e,t){n.filterText.value=t,n.props.onFilterTextChanged&&n.props.onFilterTextChanged(e,t),n.updateFilteredItems()},n.onSelect=function(e,t){var r=n.parentSelection;return r.value.length>0&&!r.multiSelect&&!r.selectOnFocus&&n.onDismiss(),n.filteredSelection.selectionChanged(e,t),!0},n.updateFilteredItems=function(){n.filteredIndexMap=[];var e=getListBoxItemsValue(n.props.items,n.wrappedItems),t=e;if(n.props.filteredItems){t=getItemsValue(n.props.filteredItems);for(var r=0;r<n.props.filteredItems.length;r++){var o=e.indexOf(t[r]);$DEBUG&&-1===o&&console.error("filteredItems contains an item not in items. Selection cannot be maintained unless filteredItems is a subset of items. Check item in filteredItems at index "+r),n.filteredIndexMap.push(o)}}else if(n.filterText.value){t=[];var l="";if(n.props.filterItem)for(var i=e.length-1;i>=0;i--)2!==e[i].type&&3!==e[i].type||!e[i].groupId||e[i].groupId!==l||(n.filteredIndexMap.unshift(i),t.unshift(e[i])),n.props.filterItem(n.filterText.value,e[i],e)&&(n.filteredIndexMap.unshift(i),t.unshift(e[i]),l=e[i].groupId);for(;t.length&&3===t[0].type;)t.shift(),n.filteredIndexMap.shift()}return n.filterText.value&&Utils_Accessibility.announce(t.length>0?format(Resources.AnnounceFilterResultCount,t.length):Resources.NoFilterResults,!0),n.filteredItems.value=t,n.filteredSelection.updateFilteredSelection(n.filteredIndexMap),!0},n.parentSelection=t.selection||new DropdownSelection,n.wrappedItems=wrapListBoxItems(t.items);var r=getListBoxItemsValue(t.items,n.wrappedItems);return n.filteredItems.value=r.slice(),n.filteredSelection=new FilteredListSelection(n.parentSelection),n.textFieldId="bolt-dropdown-textfield-"+dropdownId++,n.state={scrollBarWidth:0},n}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.ariaLabel,r=t.buttonClassName,o=t.hideDropdownIcon,l=t.items,i=t.labelClassName,s=t.onClick,a=t.onCollapse,c=t.placeholder,d=t.renderSelectedItems,p={observableValue:this.parentSelection,filter:this.onSelect};return React.createElement(ItemsObserver,{getUnselectableRanges:this.props.getUnselectableRanges,items:l,selection:this.parentSelection},React.createElement(Observer,{selection:p},function(){var t=c;return e.parentSelection.selectedCount>0&&d&&(t=d(e.parentSelection,getListBoxItemsValue(l,e.wrappedItems))),React.createElement(ExpandableButton,{ariaLabel:n,className:r,hideDropdownIcon:o,onClick:s,onCollapse:a,onExpand:e.onExpand,ref:e.expandableButton,renderCallout:e.renderDropdown},React.createElement("div",{className:css(i,"justify-start flex-grow text-ellipsis")},t))}))},t.prototype.focus=function(){this.expandableButton.current&&this.expandableButton.current.focus()},t.defaultProps={renderSelectedItems:renderDropdownSelectedItemText,filterItem:filterItemByText,getUnselectableRanges:getUnselectableRanges},t}(React.Component);export{Dropdown};export function filterItemByText(e,t){return!(!t.text||2===t.type||3===t.type)&&-1!==t.text.toLowerCase().indexOf(e.toLowerCase())};export function renderDropdownSelectedItemText(e,t){var n=t[e.value[0].beginIndex].text||"";return e.selectedCount>1&&(n=n+" (+"+(e.selectedCount-1)+")"),n};
import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import*as React from"react";import{FocusGroup}from"../../FocusGroup";import{getRelationship,shimRef}from"../../Util";export var FocusZoneContext=React.createContext({direction:void 0,focuszoneId:void 0});var ignoreEvent=!1,focuszoneId=1,FocusZone=function(e){function t(t){var o=e.call(this,t)||this;return o.rootElements=[],o.state={focuszoneId:"focuszone-"+focuszoneId++},o}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this,t=React.createElement(FocusZoneContext.Consumer,null,function(t){return React.createElement(FocusZoneContext.Provider,{value:{direction:e.props.direction,focuszoneId:e.state.focuszoneId}},React.Children.map(e.props.children,function(o,r){if("string"==typeof o||"number"==typeof o)return o;if("string"!=typeof o.type)throw Error("Children of a focus zone MUST be DOM elements");var n=o.props.onKeyDown,s=o.props.onFocus;return e.rootElements[r]=shimRef(o),React.cloneElement(o,tslib_1.__assign({key:r},o.props,{ref:e.rootElements[r],onFocus:function(t){s&&s(t);for(var o=document.activeElement,r=0;r<e.rootElements.length;r++){var n=e.rootElements[r].current;n&&(n.contains(o)||n===o)&&(e.lastFocusElement=t.target)}},onKeyDown:function(o){var r=1;if(n&&n(o),!ignoreEvent&&e.props.preprocessKeyStroke&&3===(r=e.props.preprocessKeyStroke(o))&&(ignoreEvent=!0),!ignoreEvent&&!o.defaultPrevented&&!e.props.disabled){var s=o.target.nodeName,i=void 0,c=void 0,a=void 0;if("INPUT"===s||"TEXTAREA"===s){var u=o.target;c=u.selectionStart||0,a=u.value.length}var p=void 0===c||0===c&&e.props.allowArrowOutOfInputs,l=void 0===c||void 0===a||c===a&&e.props.allowArrowOutOfInputs;switch(o.which){case 38:"TEXTAREA"!==s&&2===e.props.direction&&(i=-1);break;case 40:"TEXTAREA"!==s&&2===e.props.direction&&(i=1);break;case 39:l&&1===e.props.direction&&(i=1);break;case 37:p&&1===e.props.direction&&(i=-1);break;case 9:e.props.handleTabKey&&(i=o.shiftKey?-1:1);break;case 13:e.props.activateOnEnter&&o.target.click()}i&&e.focusNextElement(o,i)&&o.preventDefault()}2===r&&(ignoreEvent=!0),!ignoreEvent&&e.props.postprocessKeyStroke&&2===e.props.postprocessKeyStroke(o)&&(ignoreEvent=!0),t.focuszoneId||(ignoreEvent=!1)}}))}))});return this.props.focusGroupProps&&(t=React.createElement(FocusGroup,tslib_1.__assign({},this.props.focusGroupProps),t)),t},t.prototype.componentDidMount=function(){var e;if(this.props.focusOnMount){var t=this.props.defaultActiveElement,o=this.getFocusElements("function"==typeof t?t():t);o.length>0&&(e=o[0])}e&&e.focus()},t.prototype.focusNextElement=function(e,t){var o=this.getFocusElements();if(o.length>0){var r=document.activeElement,n=this.rootElements,s=o.indexOf(r);if(-1===s){var i=0;for(i=0;i<n.length;i++){var c=n[i];if(c.current&&c.current.contains(e.target))break}if(i===this.rootElements.length&&this.lastFocusElement)s=o.indexOf(this.lastFocusElement);else for(i=0;i<o.length;i++){var a=getRelationship(r,o[i]);if(1===a){s=i-(t>0?1:0);break}if(3===a){s=i;break}2===a&&i===o.length-1&&(s=o.length)}}if(s+=t,this.props.circularNavigation&&(s<0?s=o.length-1:s>=o.length&&(s=0)),s>-1&&s<o.length)return o[s].focus(),!0}return!1},t.prototype.getFocusElements=function(e){var t=[],o=e;o||(o="[data-focuszone~="+this.state.focuszoneId+"]",this.props.includeDefaults&&(o+=",a[href],button,iframe,input,select,textarea,[tabIndex]"));for(var r=0,n=this.rootElements;r<n.length;r++){var s=n[r];if(s.current){var i=s.current.querySelectorAll(o);s.current.matches(o)&&this.isFocusElement(s.current,e)&&t.push(s.current);for(var c=0;c<i.length;c++){var a=i[c];this.isFocusElement(a,e)&&t.push(a)}}}return t},t.prototype.isFocusElement=function(e,t){if(e.hasAttribute("disabled"))return!1;if(!t){if(!this.props.skipHiddenCheck){var o=window.getComputedStyle(e);if("hidden"===o.visibility||"none"===o.display||!(e.offsetWidth||e.offsetHeight||e.getClientRects().length))return!1}var r=e.getAttribute("tabindex");if(r&&parseInt(r)<0){var n=e.getAttribute("data-focuszone");if(!n||n.indexOf(this.state.focuszoneId)<0)return!1}}return!0},t}(React.Component);export{FocusZone};
import*as tslib_1 from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./IdentityPickerDropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{makeCancelable}from"../../Core/Util/Promise";import{Icon}from"../../Icon";import{Observer}from"../../Observer";import{Persona}from"../../Persona";import*as Resources from"../../Resources.IdentityPicker";import{TextField}from"../../TextField";import{css}from"../../Util";import{IdentityPickerSuggestionsList}from"../IdentityPickerSuggestionsList/IdentityPickerSuggestionsList";import{Measure}from"../../Measure";var CustomIdentityPickerDropdown=function(e){function t(t){var s=e.call(this,t)||this;return s.hasFocus=new ObservableValue(!1),s.inputElement=React.createRef(),s.openedIdentityCard=new ObservableValue(void 0),s.outerElement=React.createRef(),s.suggestionsLoading=new ObservableValue(!1),s.isEditing=new ObservableValue(!1),s.selectedIndex=new ObservableValue(-1),s.suggestions=new ObservableArray([]),s.onPickerDismiss=function(){s.props.onSuggestionsVisibleChanged(!1),s.hasFocus.value||s.props.onBlur&&s.props.onBlur()},s.renderPersonaCoin=function(e){return React.createElement(Observer,{selectedIdentity:s.props.value,isEditing:s.isEditing},function(t){return t.selectedIdentity&&!t.isEditing?React.createElement(Persona,{className:css("flex-row flex-center justify-center",e),identity:t.selectedIdentity,size:3}):React.createElement(Icon,{className:css("bolt-identitypickerdropdown-unknown-icon font-size-ml flex-row flex-center justify-center",e),iconName:"Contact"})})},s.openPersonaCard=function(e){s.openedIdentityCard.value=e},s.closePersonaCard=function(){s.openedIdentityCard.value=void 0},s.completeSuggestion=function(){s.suggestions.value.length>0&&ObservableLike.getValue(s.props.suggestionsVisible)?(s.selectedIndex.value<0&&(s.selectedIndex.value=0),s.suggestions.value&&s.suggestions.value[s.selectedIndex.value]&&s.selectedPersonaChanged(s.suggestions.value[s.selectedIndex.value]),s.props.onSuggestionsVisibleChanged(!1)):(s.selectedIndex.value=-1,s.selectedPersonaChanged())},s.onBlur=function(){s.hasFocus.value=!1,s.timerManagement.setTimeout(function(){var e=!s.openedIdentityCard.value&&!ObservableLike.getValue(s.props.suggestionsVisible);e&&s.props.onBlur&&s.props.onBlur(),e&&""===ObservableLike.getValue(s.props.textValue)&&s.selectedPersonaChanged()},100)},s.onClearClicked=function(e){s.props.onClear&&s.props.onClear(),s.props.onChange(void 0),s.lastPickedIdentity=void 0,s.suggestions.value=[],e.preventDefault()},s.onClick=function(){""===ObservableLike.getValue(s.props.textValue)&&s.props.pickerProvider.onEmptyInputFocus?(s.updateSuggestionsList(s.props.pickerProvider.onEmptyInputFocus()),s.props.onSuggestionsVisibleChanged(!ObservableLike.getValue(s.props.suggestionsVisible))):s.props.onSuggestionsVisibleChanged(!ObservableLike.getValue(s.props.suggestionsVisible)),s.inputElement.current.select()},s.onFocus=function(e){var t=s.props.onFocus;""===ObservableLike.getValue(s.props.textValue)&&s.props.pickerProvider.onEmptyInputFocus&&!ObservableLike.getValue(s.props.suggestionsVisible)&&s.updateSuggestionsList(s.props.pickerProvider.onEmptyInputFocus()),s.hasFocus.value=!0,t&&t(e)},s.onKeyDown=function(e){if(!e.isDefaultPrevented()){var t=e.which,n=ObservableLike.getValue(s.props.suggestionsVisible);switch(t){case 27:s.openedIdentityCard.value&&!(s.suggestions.value&&s.suggestions.value[s.selectedIndex.value])&&s.selectedPersonaChanged(),n&&(s.props.onSuggestionsVisibleChanged(!1),s.openedIdentityCard.value=void 0);break;case 9:case 13:!e.shiftKey&&n?(s.completeSuggestion(),e.preventDefault(),e.stopPropagation()):n&&s.completeSuggestion();break;case 39:s.suggestions.value&&s.suggestions.value[s.selectedIndex.value]&&(s.openedIdentityCard.value=s.suggestions.value[s.selectedIndex.value]);break;case 38:n&&s.suggestions.value&&(s.selectedIndex.value=Math.max(0,s.selectedIndex.value-1),s.forceUpdate(),e.preventDefault(),e.stopPropagation());break;case 40:n&&s.suggestions.value?(s.selectedIndex.value=Math.min(s.suggestions.value.length-1,s.selectedIndex.value+1),s.forceUpdate(),e.preventDefault(),e.stopPropagation()):s.props.onSuggestionsVisibleChanged(!0)}}},s.onResolveSuggestions=function(e){var t=s.props.pickerProvider.onFilterIdentities(e,[]);null!==t&&s.updateSuggestionsList(t,e)},s.onSearchChange=function(e,t){if(s.props.onSuggestionsVisibleChanged(!!t),0==t.length){var n=s.props.onClear;n&&n()}s.isEditing.value=!0,s.props.onInputChange(t),s.updateValue(t)},s.onSuggestionClick=function(e){s.selectedIndex.value=e.index,s.selectedPersonaChanged(e.item),s.props.onSuggestionsVisibleChanged(!1)},s.onTextFieldChanged=function(e,t){s.setState({width:Math.max(e,296)})},s.selectedPersonaChanged=function(e){s.lastPickedIdentity!==e&&(!!e&&!!s.props.pickerProvider.addIdentitiesToMRU&&s.props.pickerProvider.addIdentitiesToMRU([e]),!1!==s.props.onChange(e)?(s.props.onInputChange(e?e.displayName:""),s.lastPickedIdentity=e):(s.props.onInputChange(""),s.props.onChange(void 0),s.lastPickedIdentity=void 0)),s.isEditing.value=!1},s.cachedResults={},s.timerManagement=new TimerManagement,s.lastPickedIdentity=ObservableLike.getValue(t.value),s.state={width:296},s}return tslib_1.__extends(t,e),t.prototype.render=function(){var e=this,t=this.props,s=t.ariaLabel,n=void 0===s?Resources.IdentityPickerPlaceholderText:s,o=t.autoFocus,i=t.editPlaceholder,r=void 0===i?Resources.IdentityPickerPlaceholderFocusText:i,a=t.placeholder,l=void 0===a?Resources.IdentityPickerPlaceholderText:a;return React.createElement(Observer,{suggestionsVisible:this.props.suggestionsVisible},function(t){return React.createElement(React.Fragment,null,React.createElement(Measure,{onMeasure:e.onTextFieldChanged},React.createElement("div",{className:"bolt-identitypickerdropdown flex-row flex-grow",ref:e.outerElement,onBlur:e.onBlur,onKeyDown:e.onKeyDown},React.createElement(Observer,{hasFocus:e.hasFocus,selectedIdentity:e.props.value,textValue:e.props.textValue},function(s){return React.createElement(TextField,{"aria-autocomplete":"none","aria-label":n,"aria-expanded":t.suggestionsVisible,"aria-haspopup":"true",autoFocus:o,className:css(e.props.className,"bolt-identitypickerdropdown-textField flex-row flex-center",(t.suggestionsVisible||s.hasFocus)&&"bolt-identitypickerdropdown-open"),containerClassName:"bolt-identitypickerdropdown-container flex-column flex-grow",onChange:e.onSearchChange,onClick:e.onClick,onFocus:e.onFocus,prefixIconProps:{render:e.renderPersonaCoin},placeholder:s.hasFocus||s.selectedIdentity?r:l,ref:e.inputElement,role:"combobox",suffixIconProps:s.textValue?{iconName:"Clear",className:"bolt-identity-picker-clearButton fontSize",onClick:e.onClearClicked}:void 0,value:s.textValue})}))),React.createElement(Observer,{openedIdentityCard:e.openedIdentityCard,selectedIndex:e.selectedIndex},function(s){return React.createElement(IdentityPickerSuggestionsList,{calloutProps:{anchorElement:e.outerElement.current,anchorOrigin:{horizontal:"start",vertical:"end"},calloutOrigin:{horizontal:"start",vertical:"start"},contentShadow:!0,onDismiss:e.onPickerDismiss,lightDismiss:!0},suggestionsVisible:t.suggestionsVisible||!!s.openedIdentityCard,isLoading:e.suggestionsLoading,onSuggestionClicked:e.onSuggestionClick,onClosePersonaCard:e.closePersonaCard,onDismiss:e.onPickerDismiss,onOpenPersonaCard:e.openPersonaCard,openedIdentityCard:s.openedIdentityCard,pickerProvider:e.props.pickerProvider,suggestions:e.suggestions,suggestionTarget:e.outerElement.current,selectedIndex:s.selectedIndex,width:e.state.width})}))})},t.prototype.componentDidMount=function(){if(this.onResolveSuggestions=this.timerManagement.debounce(this.onResolveSuggestions,250),this.props.autoFocus){ObservableLike.getValue(this.props.textValue);this.props.pickerProvider.onEmptyInputFocus,this.updateSuggestionsList(this.props.pickerProvider.onEmptyInputFocus()),this.inputElement.current&&this.inputElement.current.select(),this.props.onSuggestionsVisibleChanged(!0)}this.setState({width:this.outerElement.current.clientWidth})},t.prototype.componentWillUnmount=function(){this.currentPromise&&this.currentPromise.cancel()},t.prototype.updateSuggestionsList=function(e,t){var s=this,n=e,o=e;if(Array.isArray(n))this.updateSuggestions(n,t);else if(o&&o.then){this.loadingTimer||(this.loadingTimer=this.timerManagement.setTimeout(function(){s.suggestionsLoading.value=!0},500));var i=this.currentPromise=makeCancelable(o);i.promise.then(function(e){i===s.currentPromise&&(s.suggestionsLoading.value=!1,s.updateSuggestions(e,t),t&&""!==t&&s.suggestions.value&&s.suggestions.value.length>0&&(s.cachedResults[t]=e),s.loadingTimer&&(s.timerManagement.clearTimeout(s.loadingTimer),s.loadingTimer=void 0))})}},t.prototype.setSuggestions=function(e,t){this.suggestions.value=e,this.selectedIndex.value=t},t.prototype.updateSuggestions=function(e,t){(void 0===t||this.inputElement.current&&ObservableLike.getValue(this.props.textValue)===t)&&this.setSuggestions(e,""===ObservableLike.getValue(this.props.textValue)?-1:0)},t.prototype.updateValue=function(e){this.cachedResults[e]?this.updateSuggestionsList(this.cachedResults[e],e):this.onResolveSuggestions(e)},t}(React.Component);export{CustomIdentityPickerDropdown};